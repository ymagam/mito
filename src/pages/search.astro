---
import Layout from "../components/Layout.astro";
import Heading from "../components/Heading.astro";
---

<Layout title="Search â€” Mitochondros" description="Search posts on Mitochondros.">
  <section class="search-page">
    <Heading as="h1">Search</Heading>
    <div class="search-input-wrap">
      <input
        type="text"
        id="search-input"
        placeholder="Search posts..."
        autocomplete="off"
        autofocus
      />
    </div>
    <ul id="search-results" class="search-results"></ul>
    <p id="search-empty" class="search-empty" hidden>No posts found.</p>
  </section>
</Layout>

<script>
  interface SearchEntry {
    slug: string;
    title: string;
    description: string;
    date: string;
    body: string;
  }

  let index: SearchEntry[] = [];
  let loaded = false;

  const input = document.getElementById("search-input") as HTMLInputElement;
  const resultsList = document.getElementById("search-results") as HTMLUListElement;
  const emptyMsg = document.getElementById("search-empty") as HTMLParagraphElement;

  async function loadIndex(): Promise<void> {
    if (loaded) return;
    const res = await fetch("/search-index.json");
    index = await res.json();
    loaded = true;
  }

  function search(query: string): SearchEntry[] {
    const terms = query.toLowerCase().split(/\s+/).filter(Boolean);
    if (terms.length === 0) return [];

    return index.filter((entry) => {
      const haystack = `${entry.title} ${entry.description} ${entry.body}`.toLowerCase();
      return terms.every((term) => haystack.includes(term));
    });
  }

  function formatDate(iso: string): string {
    return new Date(iso).toLocaleDateString("en-US", {
      year: "numeric",
      month: "long",
      day: "numeric",
    });
  }

  function render(results: SearchEntry[], query: string): void {
    resultsList.innerHTML = "";

    if (query.trim() === "") {
      emptyMsg.hidden = true;
      return;
    }

    if (results.length === 0) {
      emptyMsg.hidden = false;
      return;
    }

    emptyMsg.hidden = true;

    for (const entry of results) {
      const li = document.createElement("li");
      li.className = "search-result-item";
      li.innerHTML = `
        <a href="/posts/${entry.slug}">
          <span class="result-title">${entry.title}</span>
          <span class="result-description">${entry.description}</span>
          <time datetime="${entry.date}">${formatDate(entry.date)}</time>
        </a>
      `;
      resultsList.appendChild(li);
    }
  }

  let debounceTimer: ReturnType<typeof setTimeout>;

  input.addEventListener("input", () => {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(async () => {
      await loadIndex();
      const query = input.value;
      const results = search(query);
      render(results, query);
    }, 200);
  });

  // Support ?q= query param
  const params = new URLSearchParams(window.location.search);
  const initialQuery = params.get("q");
  if (initialQuery) {
    input.value = initialQuery;
    loadIndex().then(() => {
      const results = search(initialQuery);
      render(results, initialQuery);
    });
  }
</script>

<style>
  .search-page {
    max-width: var(--width-content);
  }

  .search-input-wrap {
    margin-top: var(--space-lg);
    margin-bottom: var(--space-xl);
  }

  #search-input {
    width: 100%;
    font-family: var(--font-heading);
    font-size: 1rem;
    padding: var(--space-sm) var(--space-md);
    border: 1px solid var(--color-border);
    border-radius: 4px;
    background: var(--color-surface);
    color: var(--color-text);
    outline: none;
    transition: border-color 0.15s ease;
  }

  #search-input:focus {
    border-color: var(--color-accent);
  }

  #search-input::placeholder {
    color: var(--color-text-tertiary);
  }

  .search-results {
    list-style: none;
    padding: 0;
  }

  .search-result-item {
    border-bottom: 1px solid var(--color-border);
  }

  .search-result-item:first-child {
    border-top: 1px solid var(--color-border);
  }

  .search-result-item a {
    display: flex;
    flex-direction: column;
    gap: var(--space-xs);
    padding: var(--space-lg) 0;
    text-decoration: none;
    color: var(--color-text);
  }

  .search-result-item a:hover .result-title {
    color: var(--color-accent);
  }

  .result-title {
    font-family: var(--font-heading);
    font-size: 1.125rem;
    font-weight: 600;
    letter-spacing: -0.01em;
    line-height: 1.3;
    transition: color 0.15s ease;
  }

  .result-description {
    font-family: var(--font-body);
    font-size: 0.9375rem;
    color: var(--color-text-secondary);
    line-height: 1.5;
  }

  .search-result-item time {
    font-family: var(--font-heading);
    font-size: 0.75rem;
    color: var(--color-text-tertiary);
    margin-top: var(--space-xs);
  }

  .search-empty {
    font-family: var(--font-heading);
    font-size: 0.875rem;
    color: var(--color-text-tertiary);
  }
</style>
